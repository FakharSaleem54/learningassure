generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                        String               @id @default(uuid()) @db.Uuid
  email                     String               @unique @db.VarChar(255)
  name                      String?              @db.VarChar(255)
  password                  String               @db.VarChar(255)
  role                      String               @default("LEARNER") @db.VarChar(20)
  status                    String               @default("ACTIVE") @db.VarChar(20)
  createdAt                 DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt                 DateTime             @updatedAt @db.Timestamptz(6)
  certificates              Certificate[]
  courses                   Course[]             @relation("InstructorCourses")
  enrollments               Enrollment[]
  replies                   ForumReply[]         @relation("UserReplies")
  threads                   ForumThread[]        @relation("UserThreads")
  lessonProgress            LessonProgress[]
  instructorMeetingRequests LiveMeetingRequest[] @relation("InstructorMeetings")
  studentMeetingRequests    LiveMeetingRequest[] @relation("StudentMeetings")
  notifications             Notification[]
  replyVotes                ReplyVote[]          @relation("UserReplyVotes")
  threadVotes               ThreadVote[]         @relation("UserThreadVotes")

  @@index([email])
  @@index([role])
}

model Course {
  id              String               @id @default(uuid()) @db.Uuid
  title           String               @db.VarChar(255)
  description     String
  price           Decimal              @default(0.0) @db.Decimal(10, 2)
  category        String               @default("Uncategorized") @db.VarChar(100)
  status          String               @default("PENDING") @db.VarChar(20)
  published       Boolean              @default(false)
  thumbnail       String?              @db.VarChar(500)
  instructorId    String               @db.Uuid
  createdAt       DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime             @updatedAt @db.Timestamptz(6)
  instructor      User                 @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  enrollments     Enrollment[]
  threads         ForumThread[]        @relation("CourseThreads")
  meetingRequests LiveMeetingRequest[]
  modules         Module[]

  @@index([instructorId])
  @@index([category])
  @@index([published])
}

model Module {
  id       String   @id @default(uuid()) @db.Uuid
  title    String   @db.VarChar(255)
  order    Int      @default(0)
  courseId String   @db.Uuid
  lessons  Lesson[]
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Lesson {
  id               String               @id @default(uuid()) @db.Uuid
  title            String               @db.VarChar(255)
  content          String?
  videoUrl         String?              @db.VarChar(500)
  duration         Int?
  description      String?              @db.Text
  order            Int                  @default(0)
  moduleId         String               @db.Uuid
  isReady          Boolean              @default(true)
  module           Module               @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress         LessonProgress[]
  resources        LessonResource[]
  meetingRequests  LiveMeetingRequest[]
  quiz             Quiz?
  transcript       Transcript?
  transcriptionJob TranscriptionJob?

  @@index([moduleId])
}

model LessonResource {
  id        String   @id @default(uuid()) @db.Uuid
  title     String   @db.VarChar(255)
  fileUrl   String   @db.VarChar(500)
  fileName  String   @db.VarChar(255)
  fileSize  Int      @default(0)
  lessonId  String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model TranscriptionJob {
  id        String   @id @default(uuid()) @db.Uuid
  lessonId  String   @unique @db.Uuid
  status    String   @default("PENDING") @db.VarChar(20)
  attempts  Int      @default(0)
  error     String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([status])
}

model Transcript {
  id        String   @id @default(uuid()) @db.Uuid
  lessonId  String   @unique @db.Uuid
  content   String
  segments  Json?
  language  String   @default("en") @db.VarChar(10)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model Quiz {
  id          String        @id @default(uuid()) @db.Uuid
  lessonId    String        @unique @db.Uuid
  questions   Json
  generatedAt DateTime      @default(now()) @db.Timestamptz(6)
  lesson      Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts    QuizAttempt[]

  @@index([lessonId])
}

model QuizAttempt {
  id             String   @id @default(uuid()) @db.Uuid
  quizId         String   @db.Uuid
  userId         String   @db.Uuid
  score          Int
  totalQuestions Int      @default(10)
  answers        Json
  completedAt    DateTime @default(now()) @db.Timestamptz(6)
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
}

model Enrollment {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @db.Uuid
  courseId    String       @db.Uuid
  progress    Decimal      @default(0.0) @db.Decimal(5, 2)
  completed   Boolean      @default(false)
  enrolledAt  DateTime     @default(now()) @db.Timestamptz(6)
  certificate Certificate?
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  lessonId    String   @db.Uuid
  completed   Boolean  @default(false)
  completedAt DateTime @default(now()) @db.Timestamptz(6)
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Certificate {
  id           String     @id @default(uuid()) @db.Uuid
  enrollmentId String     @unique @db.Uuid
  userId       String     @db.Uuid
  issuedAt     DateTime   @default(now()) @db.Timestamptz(6)
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ForumThread {
  id          String       @id @default(uuid()) @db.Uuid
  title       String       @db.VarChar(500)
  content     String
  authorId    String       @db.Uuid
  courseId    String?      @db.Uuid
  tags        String?      @db.VarChar(500)
  upvotes     Int          @default(0)
  viewCount   Int          @default(0)
  isResolved  Boolean      @default(false)
  createdAt   DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt @db.Timestamptz(6)
  attachments Json?
  replies     ForumReply[]
  author      User         @relation("UserThreads", fields: [authorId], references: [id], onDelete: Cascade)
  course      Course?      @relation("CourseThreads", fields: [courseId], references: [id])
  votes       ThreadVote[]

  @@index([authorId])
  @@index([courseId])
  @@index([createdAt])
}

model ForumReply {
  id          String       @id @default(uuid()) @db.Uuid
  content     String
  authorId    String       @db.Uuid
  threadId    String       @db.Uuid
  parentId    String?      @db.Uuid
  upvotes     Int          @default(0)
  isAccepted  Boolean      @default(false)
  createdAt   DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt @db.Timestamptz(6)
  attachments Json?
  author      User         @relation("UserReplies", fields: [authorId], references: [id], onDelete: Cascade)
  parent      ForumReply?  @relation("NestedReplies", fields: [parentId], references: [id])
  children    ForumReply[] @relation("NestedReplies")
  thread      ForumThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  votes       ReplyVote[]

  @@index([authorId])
  @@index([threadId])
  @@index([parentId])
}

model ThreadVote {
  id        String      @id @default(uuid()) @db.Uuid
  userId    String      @db.Uuid
  threadId  String      @db.Uuid
  value     Int         @db.SmallInt
  createdAt DateTime    @default(now()) @db.Timestamptz(6)
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User        @relation("UserThreadVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
  @@index([threadId])
}

model ReplyVote {
  id        String     @id @default(uuid()) @db.Uuid
  userId    String     @db.Uuid
  replyId   String     @db.Uuid
  value     Int        @db.SmallInt
  createdAt DateTime   @default(now()) @db.Timestamptz(6)
  reply     ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  user      User       @relation("UserReplyVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, replyId])
  @@index([replyId])
}

model LiveMeetingRequest {
  id            String    @id @default(uuid()) @db.Uuid
  studentId     String    @db.Uuid
  instructorId  String    @db.Uuid
  courseId      String    @db.Uuid
  lectureId     String?   @db.Uuid
  objective     String
  status        String    @default("PENDING") @db.VarChar(20)
  preferredTime DateTime? @db.Timestamptz(6)
  meetingLink   String?   @db.VarChar(500)
  zoomMeetingId String?   @db.VarChar(100)
  zoomJoinUrl   String?   @db.VarChar(500)
  zoomStartUrl  String?   @db.VarChar(500)
  notes         String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor    User      @relation("InstructorMeetings", fields: [instructorId], references: [id], onDelete: Cascade)
  lecture       Lesson?   @relation(fields: [lectureId], references: [id])
  student       User      @relation("StudentMeetings", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([instructorId])
  @@index([courseId])
  @@index([status])
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  message   String
  type      String   @default("INFO") @db.VarChar(20)
  link      String?  @db.VarChar(500)
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model LectureChunk {
  id           String   @id @default(uuid()) @db.Uuid
  courseId     String   @db.Uuid
  lectureTitle String   @db.VarChar(255)
  chunkText    String
  embedding    String
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@index([courseId])
}

model ChatMessage {
  id          String   @id @default(uuid()) @db.Uuid
  courseId    String   @db.Uuid
  sender      String   @db.VarChar(20)
  messageText String
  timestamp   DateTime @default(now()) @db.Timestamptz(6)

  @@index([courseId])
  @@index([timestamp])
}

model UserActivityLog {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Uuid
  sessionId    String?  @db.Uuid
  eventType    String   @db.VarChar(50)
  eventAction  String   @db.VarChar(100)
  resourceType String?  @db.VarChar(50)
  resourceId   String?  @db.Uuid
  metadata     Json?
  clientInfo   Json?
  duration     Int?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([resourceType, resourceId])
  @@index([createdAt])
}

model UserBehaviorProfile {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @unique @db.Uuid
  learningPreferences   Json?
  engagementPatterns    Json?
  contentInteractions   Json?
  skillProfile          Json?
  recommendationSignals Json?
  createdAt             DateTime @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @db.Timestamptz(6)

  @@index([userId])
}

model AIRecommendation {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @db.Uuid
  recommendationType String    @db.VarChar(50)
  resourceType       String    @db.VarChar(50)
  resourceId         String    @db.Uuid
  details            Json?
  modelInfo          Json?
  status             String    @default("PENDING") @db.VarChar(20)
  clickedAt          DateTime? @db.Timestamptz(6)
  dismissedAt        DateTime? @db.Timestamptz(6)
  expiresAt          DateTime? @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([recommendationType])
  @@index([resourceType, resourceId])
  @@index([status])
  @@index([createdAt])
}

model LearningAnalytics {
  id                String   @id @default(uuid()) @db.Uuid
  courseId          String   @db.Uuid
  periodStart       DateTime @db.Timestamptz(6)
  periodEnd         DateTime @db.Timestamptz(6)
  periodType        String   @db.VarChar(20)
  engagementMetrics Json?
  completionMetrics Json?
  assessmentMetrics Json?
  feedbackMetrics   Json?
  createdAt         DateTime @default(now()) @db.Timestamptz(6)

  @@unique([courseId, periodStart, periodType])
  @@index([courseId])
  @@index([periodStart])
  @@index([periodType])
}

model UserSession {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @db.Uuid
  startedAt      DateTime  @default(now()) @db.Timestamptz(6)
  endedAt        DateTime? @db.Timestamptz(6)
  duration       Int?
  deviceInfo     Json?
  sessionSummary Json?
  trafficSource  Json?

  @@index([userId])
  @@index([startedAt])
}
